/*! jsSurvivor - v0.1.0 - 2017-01-05
* https://github.com/Nilanno/jsSurvivor
* Copyright (c) 2017 Nilanno;*/
function ObjectCollider(a,b){this.gameInfo=a,this.gameObjects=b,this.checkCollisions=function(a){for(var c=b.concat(a),d=0,e=c.length;e>d;++d)for(var f=d;e>f;++f)this.collide(c[d],c[f])},this.collide=function(a,b){if(!(a.toRemove||a.dead||b.toRemove||b.dead)){var c=null;c=a.collisionFn(b),c&&a.collide(b,c),c=b.collisionFn(a),c&&b.collide(a,c)}}}function Enemy(a,b,c){this.gameInfo=a,this.h=this.w=30,this.x=b,this.y=c,this.wide=(this.h+this.w)/4,this.velocity=UTILS.getSpeed(10),this.health=100,this.damage=4,this.reloadTime=1e3,this.isReloading=!1,this.score=1,this.spriteSize=RES.enemy.spriteSize,this.img=RES.enemy.img,this.collisionTargets[Bullet.name]=function(a){this.health-=a.damage,this.checkDead()},!b&&!c&&UTILS.randomBorderPosition(this,this.gameInfo),this.hit=function(a){this.isReloading||this.dead||(this.isReloading=!0,a.health-=this.damage,UTILS.setTimeout(function(){this.isReloading=!1},this.reloadTime,this))},this.draw=function(a){a.drawImage(this.img,0,0,this.spriteSize,this.spriteSize,this.x-this.w/2,this.y-this.h/2,this.w,this.h)},this.calculateNextStep=function(a){if(!this.checkDead()&&!this.dead){var b=this.velocity*a/1e3,c=Math.atan2(this.gameInfo.player.y-this.y,this.gameInfo.player.x-this.x),d=Math.cos(c)*b,e=Math.sin(c)*b;d&&(this.x+=d),e&&(this.y+=e)}};var d=null;this.dropLoot=function(){if(UTILS.random()<=.3){var b=new Medkit(this.gameInfo,this.x,this.y);this.gameInfo.gameObjects.push(b)}else if(UTILS.random()<=.6){var b=new Grenade(this.gameInfo,this.x,this.y);this.gameInfo.gameObjects.push(b)}var c=this.getDead();a.gameObjects.push(c),d=UTILS.setTimeout(function(){c.toRemove=!0},5e3,this)},this.getDead=function(){var b=new Enemy(a,this.x,this.y),c=1&UTILS.random()?0:RES.enemy.spriteSize;return b.dead=!0,b.draw=function(){ctx.drawImage(RES.enemy.dead,c,0,RES.enemy.spriteSize,RES.enemy.spriteSize,this.x-this.w/2,this.y-this.h/2,this.w,this.h)},b}}function GameEngine(a){var b=this,c=0,d=0,e=a.canvas,f=e.getContext("2d"),g=null,h={w:a.width,h:a.height,score:0,direction:"",mouseX:0,mouseY:0,player:null,gameObjects:null,showCollisions:!1};window.ctx=f,this.reset=function(){h.w=a.width,h.h=a.height,h.score=0,h.direction="",h.mouseX=0,h.mouseY=0,e.width=h.w,e.height=h.h,f.font="italic 15pt Arial",b.lastTimestamp=null,b.dt=null,b.running=!1,b.fps=0,b.gameInfo=h,h.player=b.player=new Player(h),h.gameObjects=b.gameObjects=[b.player],UTILS.inverseArray(h.gameObjects),b.objectCollider=new ObjectCollider(b.gameInfo,b.gameObjects),b.end=""},this.reset(),this.shoot=function(a){b.player.weapon.fire=!!a,b.running&&b.player.shoot(a)},this.start=function(){this.running||(this.end&&this.reset(),this.startGenerateEnemies(),this.running=!0,b.lastTimestamp=0,this.render(0))},this.stop=function(){this.running=!1,this.stopGenerateEnemies(),this.hideFPS()};var i=null;this.startGenerateEnemies=function(){i=UTILS.setInterval(function(){b.gameObjects.push(new Enemy(h))},410)},this.stopGenerateEnemies=function(){i&&i()},this.render=function(a){b.lastTimestamp||(b.lastTimestamp=a),b.dt=a-b.lastTimestamp,b.lastTimestamp=a,b.end?f.fillText(b.end,b.gameInfo.w/2,b.gameInfo.h/2):b.drawAll(),b.running&&(b.objectCollider.checkCollisions(b.player.getBullets()),b.calculateNextStep(),b.showFPS(),b.showScore(),b.showHealth(),g&&g.drawControls&&g.drawControls(),requestAnimationFrame(b.render,e))},this.showFPS=function(){d>1e3&&(this.fps=c,c=0,d=0),++c,d+=this.dt,f.fillText("FPS:"+this.fps,10,20)},this.hideFPS=function(){d=0,c=0},this.showScore=function(){f.fillText("Score:"+this.gameInfo.score,this.gameInfo.w-150,20)},this.showHealth=function(){var a=this.player.health;0>=a&&(a=0,this.end="DEFEAT",this.stop()),f.fillText("HP:"+a,this.gameInfo.w-150,45)},this.drawAll=function(){f.clearRect(0,0,h.w,h.h),f.drawImage(RES.background.img,0,0),this.gameObjects.forEach(function(a){a.draw(f),h.showCollisions&&UTILS.showCollision(f,a)}),this.showMouse()},this.showMouse=function(){f.drawImage(RES.crosshair.img,this.player.weapon.crosshair*RES.crosshair.spriteSize,0,RES.crosshair.spriteSize,RES.crosshair.spriteSize,h.mouseX-this.player.weapon.crosshairSize,h.mouseY-this.player.weapon.crosshairSize,this.player.weapon.crosshairSize,this.player.weapon.crosshairSize)},this.calculateNextStep=function(){UTILS.calculateArrayNextStep(this.gameObjects,b.dt,b.gameInfo)},this.bindControls=function(){e.onmousedown=function(){return b.shoot(!0),!1},e.onmouseup=function(){b.shoot()},document.onmousemove=function(a){h.mouseX=a.pageX,h.mouseY=a.pageY},window.onkeydown=function(c){var d=CONSTANTS.keys[c.keyCode];CONSTANTS.direction[d]&&h.direction.indexOf(d)<0?h.direction+=d:d===CONSTANTS.space&&(c.preventDefault(),b.running?b.stop():b.start(),a.toggleGameControls&&a.toggleGameControls(b.running))},window.onkeyup=function(a){var b=CONSTANTS.keys[a.keyCode];CONSTANTS.direction[b]&&h.direction.indexOf(b)>=0&&(h.direction=h.direction.replace(b,""))},Touch.isTouchDevice()&&(g=new Touch(f,h,b.shoot),g.drawControls(),e.addEventListener("touchstart",g.handleStart,!1),e.addEventListener("touchend",g.handleEnd,!1),e.addEventListener("touchcancel",g.handleCancel,!1),e.addEventListener("touchmove",g.handleMove,!1))}}function GameObject(a){this.gameInfo=a,this.toRemove=!1,this.x=0,this.y=0,this.w=0,this.h=0,this.collisionTargets={},this.draw=function(){},this.calculateNextStep=function(){},this.isOutOfCanvas=function(a,b){return this.x+this.w/2+a>this.gameInfo.w||this.x-this.w/2+a<0||this.y+this.h/2+b>this.gameInfo.h||this.y-this.h/2+b<0},this.collide=function(a,b){b.call(this,a)},this.collisionFn=function(a){return a.fn.name in this.collisionTargets?this.inCollisionRange(a)&&this.collisionTargets[a.fn.name]:null},this.inCollisionRange=function(a){var b=UTILS.hypot(this.x,this.y,a.x,a.y);return a.wide+this.wide>=b},this.checkDead=function(){return this.health<=0?(this.dead=0,this.score>0&&(this.gameInfo.score+=this.score,this.score=0,this.dropLoot()),this.toRemove=!0):this.toRemove},this.dropLoot=function(){}}function Grenade(a,b,c){this.w=this.h=30,this.wide=15,this.x=b,this.y=c,this.ttl=1e4,this.health=1,this.damage=1e3,this.gameInfo=a,UTILS.setTimeout(function(){this.toRemove=!0},this.ttl,this),this.gameInfo=a,this.collisionTargets[Player.name]=function(){this.health=0,this.destroyEnemies(),this.checkDead()},this.draw=function(a){a.drawImage(RES.grenade.img,0,0,RES.grenade.spriteSize,RES.grenade.spriteSize,this.x-this.w/2,this.y-this.h/2,this.w,this.h)},this.destroyEnemies=function(){a.gameObjects.forEach(function(a){a.fn===Enemy&&a.health>0&&!a.dead&&(a.health=0,a.checkDead())})}}function Medkit(a,b,c){this.w=this.h=20,this.wide=15,this.x=b,this.y=c,this.ttl=1e4,this.health=17,UTILS.setTimeout(function(){this.toRemove=!0},this.ttl,this),this.gameInfo=a,this.draw=function(a){a.drawImage(RES.medkit.img,0,0,RES.medkit.spriteSize,RES.medkit.spriteSize,this.x-this.w/2,this.y-this.h/2,this.w,this.h)},this.hit=function(a){a.health+=this.health,this.health=0,a.health>100&&(a.health=100),this.checkDead()}}function Player(a){this.gameInfo=a,this.h=this.w=30,this.wide=(this.w+this.h)/4,this.y=a.h/2,this.x=a.w/2,this.velocity=UTILS.getSpeed(8.5),this.weapon=new BaseWeapon(this.gameInfo,this),this.health=100,this.collisionTargets[Enemy.name]=function(a){a.hit(this)},this.collisionTargets[Medkit.name]=function(a){a.hit(this)},this.draw=function(a){var b=(180*Math.atan2(this.y-this.gameInfo.mouseY,this.gameInfo.mouseX-this.x)/Math.PI+360)%360,c=30;a.drawImage(RES.player.img,(b/c>>0)*RES.player.spriteSize,this.weapon.fire?RES.player.spriteSize:0,RES.player.spriteSize,RES.player.spriteSize,this.x-this.w/2,this.y-this.h/2,this.w,this.h),this.weapon.draw(a)},this.calculateNextStep=function(a){var b=0,c=0;this.gameInfo.direction.indexOf(CONSTANTS.direction.up)>=0?c=-1*this.velocity*(a/1e3):this.gameInfo.direction.indexOf(CONSTANTS.direction.down)>=0&&(c=this.velocity*(a/1e3)),this.gameInfo.direction.indexOf(CONSTANTS.direction.left)>=0?b=-1*this.velocity*(a/1e3):this.gameInfo.direction.indexOf(CONSTANTS.direction.right)>=0&&(b=this.velocity*(a/1e3)),this.isOutOfCanvas(b,c)&&(b=0,c=0),b&&(this.gameInfo.player.x=this.x+=b),c&&(this.gameInfo.player.y=this.y+=c),this.weapon.calculateNextStep(a)};var b=null;this.shoot=function(a){if(a){if(!b){this.weapon.fire=!0;var c=this;c.weapon.shoot(),b=UTILS.setInterval(c.weapon.shoot,this.weapon.fireDelay,c.weapon)}}else this.weapon.fire=!1,b&&b(),b=null},this.getBullets=function(){return[].concat(this.weapon.bullets)}}function Touch(a,b,c){var d=this;this.ctx=a,this.gameInfo=b,this.touches=[],this.shootFn=c,this.fireControl={x:0,y:0,r:0},this.moveControl={x:0,y:0,r:0},this.ongoingTouchIndexById=function(a){for(var b=0;b<this.touches.length;b++){var c=this.touches[b].identifier;if(c==a)return b}return-1},this.drawControls=function(){this.fireControl={x:60,y:this.gameInfo.h-60,r:60},this.moveControl={x:this.gameInfo.w-60,y:this.gameInfo.h-60,r:60},this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.fireControl.x,this.fireControl.y,this.fireControl.r,0,360),this.ctx.fillStyle="rgba(160, 22, 22, 0.5)",this.ctx.fill(),this.ctx.lineWidth=3,this.ctx.strokeStyle="#222",this.ctx.stroke(),this.ctx.restore(),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.moveControl.x,this.moveControl.y,this.moveControl.r,0,360),this.ctx.fillStyle="rgba(160, 22, 22, 0.5)",this.ctx.fill(),this.ctx.lineWidth=3,this.ctx.strokeStyle="#222",this.ctx.stroke(),this.ctx.restore()},this.handleStart=function(a){a.preventDefault();for(var b=a.target,c=(b.getContext("2d"),a.changedTouches),e=0;e<c.length;e++)d.touches.push(d.copyTouch(c[e]));d.calculateDirections()},this.handleMove=function(a){a.preventDefault();for(var b=a.target,c=(b.getContext("2d"),a.changedTouches),e=0;e<c.length;e++){var f=d.ongoingTouchIndexById(c[e].identifier);f>=0?d.touches.splice(f,1,d.copyTouch(c[e])):console.log("can't figure out which touch to continue")}d.calculateDirections()},this.handleEnd=function(a){a.preventDefault();for(var b=a.target,c=(b.getContext("2d"),a.changedTouches),e=0;e<c.length;e++){var f=d.ongoingTouchIndexById(c[e].identifier);f>=0?d.touches.splice(f,1):console.log("can't figure out which touch to end")}d.calculateDirections()},this.handleCancel=function(a){for(var b=a.changedTouches,c=0;c<b.length;c++)d.touches.splice(c,1);d.calculateDirections()},this.copyTouch=function(a){return{identifier:a.identifier,pageX:a.pageX,pageY:a.pageY}},this.getFireDirection=function(){var a=this.getAngle(this.fireControl);return a?{rad:a,deg:UTILS.radToDegrees(a)}:null},this.getMoveDirection=function(){var a=this.getAngle(this.moveControl);return a?{rad:a,deg:UTILS.radToDegrees(a)}:null},this.getAngle=function(a){var b=null;return this.touches.some(function(c){var d=UTILS.hypot(a.x,a.y,c.pageX,c.pageY);return d>a.r?!1:(b=Math.atan2(c.pageY-a.y,c.pageX-a.x),!0)}),b},this.calculateDirections=function(){var a=d.getMoveDirection(),b=d.getFireDirection(),c=this.gameInfo,e=CONSTANTS.direction;a||(c.direction=""),a&&(c.direction=a.deg<=45&&a.deg>-45?""+e.right:a.deg>45&&a.deg<135?""+e.down:a.deg>=135||a.deg<=-135?""+e.left:""+e.up),b?(this.shootFn(!0),c.mouseX=150*Math.cos(b.rad)+c.player.x,c.mouseY=150*Math.sin(b.rad)+c.player.y):this.shootFn()}}function BaseWeapon(a,b){this.gameInfo=a,this.player=b,this.bullets=[],this.fire=!1,this.fireDelay=300,this.crosshair=0,this.crosshairSize=25,this.shoot=function(){this.fire&&this.bullets.push(new Bullet(this.gameInfo,this.player.x,this.player.y))},this.draw=function(a){this.bullets.forEach(function(b){b.draw(a)})},this.calculateNextStep=function(a){UTILS.calculateArrayNextStep(this.bullets,a,this.gameInfo)}}function Bullet(a,b,c){this.gameInfo=a,this.x=b,this.y=c,this.toX=this.gameInfo.mouseX,this.toY=this.gameInfo.mouseY,this.velocity=400,this.damage=100,this.wide=this.h=this.w=2,this.angle=Math.atan2(this.toY-this.y,this.toX-this.x),this.collisionTargets[Enemy.name]=function(){this.health=0,this.checkDead()},this.draw=function(a){a.save(),a.beginPath(),a.arc(this.x,this.y,this.w,0,360,!1),a.fill(),a.restore()},this.calculateNextStep=function(a){if(!this.checkDead()){var b=this.velocity*a/1e3,c=Math.cos(this.angle)*b,d=Math.sin(this.angle)*b;c&&(this.x+=c),d&&(this.y+=d),this.isOutOfCanvas(c,d)&&(this.toRemove=!0)}}}function NewGame(){function a(a){c.disabled=a,d.disabled=!a}var b=document.getElementById("mainCanvas"),c=document.getElementById("startButton"),d=document.getElementById("stopButton"),e=new GameEngine({canvas:b,width:screen.availWidth-220,height:screen.availHeight-100,toggleGameControls:a});e.bindControls(),c.addEventListener("click",function(){e.start(),a(!0)}),d.addEventListener("click",function(){e.stop(),a(!1)}),window.scrollTo(0,0)}Enemy.prototype=new GameObject,Enemy.prototype.fn=Enemy,GameObject.prototype.fn=GameObject,Grenade.prototype=new GameObject,Grenade.prototype.fn=Grenade,Medkit.prototype=new GameObject,Medkit.prototype.fn=Medkit,Player.prototype=new GameObject,Player.prototype.fn=Player;var RES={player:{img:document.getElementById("playerSprites"),spriteSize:30},medkit:{img:document.getElementById("medkitSprite"),spriteSize:182},grenade:{img:document.getElementById("grenadeSprite"),spriteSize:230},crosshair:{img:document.getElementById("crosshairSprites"),spriteSize:81},enemy:{img:document.getElementById("enemySprite"),spriteSize:190,dead:document.getElementById("deadEnemySprite")},background:{img:document.getElementById("backgroundSprite"),spriteSize:0,w:2048,h:1536}},CONSTANTS={direction:{up:"up",down:"down",right:"right",left:"left"},space:"space"};CONSTANTS.keys={38:CONSTANTS.direction.up,87:CONSTANTS.direction.up,40:CONSTANTS.direction.down,83:CONSTANTS.direction.down,37:CONSTANTS.direction.left,65:CONSTANTS.direction.left,39:CONSTANTS.direction.right,68:CONSTANTS.direction.right,32:CONSTANTS.space},Touch.isTouchDevice=function(){return"ontouchstart"in window||"onmsgesturechange"in window};var UTILS={calculateArrayNextStep:function(a,b){if(a)for(var c=a.length-1;c>=0;c--)a[c].calculateNextStep(b),a[c].toRemove&&a.splice(c,1)},hypot:function(a,b,c,d){return Math.pow(Math.pow(a-c,2)+Math.pow(b-d,2),.5)},random:function(a){return!a&&(a=10),Math.random()*a},randomBorderPosition:function(a,b){1&UTILS.random()?(a.x=1&UTILS.random()?0:b.w,a.y=UTILS.random(b.h)):(a.y=1&UTILS.random()?0:b.h,a.x=UTILS.random(b.w))},setInterval:function(a,b,c){var d=c?function(){a.call(c)}:a,e=setInterval(d,b);return function(){clearInterval(e)}},setTimeout:function(a,b,c){var d=c?function(){a.call(c)}:a,e=setTimeout(d,b);return function(){clearTimeout(e)}},showCollision:function(a,b){a.save(),a.beginPath(),a.strokeStyle="red",a.arc(b.x,b.y,b.wide,0,360,!1),a.stroke(),a.restore()},inverseArray:function(a){a.push=function(){Array.prototype.unshift.apply(this,arguments)},a.unshift=function(){Array.prototype.push.apply(this,arguments)}},radToDegrees:function(a){return 180*a/Math.PI},getSpeed:function(a){return Math.min(screen.availHeight,screen.availWidth)/a}};BaseWeapon.prototype=new GameObject,BaseWeapon.prototype.fn=BaseWeapon,Bullet.prototype=new GameObject,Bullet.prototype.fn=Bullet,window.addEventListener("load",NewGame,!1),window.addEventListener("resize",function(){location.reload()});